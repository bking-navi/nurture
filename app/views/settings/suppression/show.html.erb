<% content_for :breadcrumb do %>
  <div class="flex items-center gap-1.5">
    <%= link_to "Settings", advertiser_settings_path(@advertiser.slug), class: "text-neutral-500 hover:text-neutral-700" %>
    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
    </svg>
    <span class="text-neutral-600 font-medium">Suppression</span>
  </div>
<% end %>

<!-- Flash Messages -->
<% if notice %>
  <div class="mb-6 bg-green-50 border border-green-200 rounded-md p-4">
    <p class="text-sm text-green-800"><%= notice %></p>
  </div>
<% end %>
<% if alert %>
  <div class="mb-6 bg-red-50 border border-red-200 rounded-md p-4">
    <p class="text-sm text-red-800"><%= alert %></p>
  </div>
<% end %>

<%= form_with model: @advertiser, url: settings_update_suppression_path(@advertiser.slug), method: :patch, id: "suppression-form" do |f| %>
  <!-- Header with Actions -->
  <div class="mb-6">
    <div class="flex items-start justify-between mb-8">
      <div>
        <h1 class="text-xl font-semibold text-gray-700 tracking-tight">Suppression</h1>
        <p class="text-sm text-gray-600 mt-1">You can override these settings on your campaigns.</p>
      </div>
      <div class="flex items-center gap-2">
        <button type="button" class="px-2.5 py-1.5 border border-gray-300 text-sm font-medium text-gray-700 bg-gray-50 rounded-md hover:bg-gray-100">
          History
        </button>
        <%= f.submit "Save Settings", class: "px-2.5 py-1.5 text-sm font-medium text-white bg-gray-900 rounded-md hover:bg-gray-800 cursor-pointer" %>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-3 gap-5">
        <!-- Left Column - Suppression Cards -->
        <div class="col-span-2 space-y-5">
          
          <!-- Recent Orders Card -->
          <div class="bg-white border border-gray-200 rounded-lg p-4">
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center gap-2.5">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <h3 class="text-base font-semibold text-gray-700">Recent Orders</h3>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <%= f.check_box :recent_order_enabled, 
                                checked: (@advertiser.recent_order_suppression_days > 0), 
                                class: "sr-only peer",
                                onchange: "toggleRecentOrders(this.checked)" %>
                <div class="w-8 h-[18px] bg-gray-900 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3.5 after:w-3.5 after:transition-all peer-checked:bg-gray-900"></div>
              </label>
            </div>
            <p class="text-xs text-gray-500 mb-6">Improve your campaign efficiency by removing customers with recent purchases from your eligible mailing list.</p>
            
            <div class="space-y-4">
              <div class="flex items-baseline justify-between">
                <span class="text-sm font-semibold text-gray-700">Duration</span>
                <span id="recent-order-value" class="text-sm font-semibold text-gray-600"><%= @advertiser.recent_order_suppression_days %> days</span>
              </div>
              
              <div class="flex items-center gap-3">
                <span class="text-xs text-gray-700">7 days</span>
                <%= f.range_field :recent_order_suppression_days, 
                                  min: 7, 
                                  max: 90, 
                                  value: @advertiser.recent_order_suppression_days,
                                  class: "flex-1 h-2 bg-gray-200 rounded-full appearance-none cursor-pointer slider-dark",
                                  oninput: "updateOrderValue(this.value)" %>
                <span class="text-xs text-gray-700">90 days</span>
              </div>
              
              <div class="bg-gray-100 border border-gray-200 rounded p-3">
                <p id="recent-order-description" class="text-xs text-gray-500">
                  <% if @advertiser.recent_order_suppression_days >= 60 %>
                    Very conservative - Best for infrequent purchase categories
                  <% elsif @advertiser.recent_order_suppression_days >= 30 %>
                    Balanced - Best for products that are purchased every 1-2 months
                  <% else %>
                    Aggressive - Best for frequently purchased products
                  <% end %>
                </p>
              </div>
            </div>
          </div>

          <!-- Mailing Frequency Card -->
          <div class="bg-white border border-gray-200 rounded-lg p-4">
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center gap-2.5">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="text-base font-semibold text-gray-700">Mailing Frequency</h3>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <%= f.check_box :recent_mail_enabled, 
                                checked: (@advertiser.recent_mail_suppression_days > 0), 
                                class: "sr-only peer",
                                onchange: "toggleRecentMail(this.checked)" %>
                <div class="w-8 h-[18px] bg-gray-900 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3.5 after:w-3.5 after:transition-all peer-checked:bg-gray-900"></div>
              </label>
            </div>
            <p class="text-xs text-gray-500 mb-6">Prevent fatigue by limiting how often your customers can receive your post cards.</p>
            
            <div class="space-y-4">
              <div class="flex items-baseline justify-between">
                <span class="text-sm font-semibold text-gray-700">Frequency</span>
                <span id="recent-mail-value" class="text-sm font-semibold text-gray-600"><%= @advertiser.recent_mail_suppression_days %> days</span>
              </div>
              
              <div class="flex items-center gap-3">
                <span class="text-xs text-gray-700">7 days</span>
                <%= f.range_field :recent_mail_suppression_days, 
                                  min: 7, 
                                  max: 90, 
                                  value: @advertiser.recent_mail_suppression_days,
                                  class: "flex-1 h-2 bg-gray-200 rounded-full appearance-none cursor-pointer slider-dark",
                                  oninput: "updateMailValue(this.value)" %>
                <span class="text-xs text-gray-700">90 days</span>
              </div>
              
              <div class="bg-gray-100 border border-gray-200 rounded p-3">
                <p id="recent-mail-description" class="text-xs text-gray-500">
                  <% if @advertiser.recent_mail_suppression_days >= 60 %>
                    Very conservative - Best for infrequent campaigns
                  <% elsif @advertiser.recent_mail_suppression_days >= 30 %>
                    Balanced - Best for products that are purchased every 1-2 months
                  <% else %>
                    Aggressive - Best for high-frequency campaigns
                  <% end %>
                </p>
              </div>
            </div>
          </div>

          <!-- Suppression Lists Card -->
          <div class="bg-white border border-gray-200 rounded-lg p-4">
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center gap-2.5">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                </svg>
                <h3 class="text-base font-semibold text-gray-700">Suppression Lists</h3>
              </div>
              <button type="button" onclick="document.getElementById('csv-upload-input').click()" class="px-2.5 py-1.5 border border-gray-300 text-xs font-medium text-gray-700 bg-gray-50 rounded-md hover:bg-gray-100 flex items-center gap-1.5">
                Import
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
              </button>
            </div>
            <p class="text-xs text-gray-500 mb-4">Manage your own suppression files to ensure certain groups never receive post cards.</p>
            
            <!-- File Upload Area -->
            <div class="bg-gray-50 border-2 border-dashed border-gray-200 rounded-lg p-8">
              <div class="flex flex-col items-center text-center">
                <svg class="w-6 h-6 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-sm font-medium text-gray-600 mb-1">Upload a Suppression File</p>
                <p class="text-xs text-gray-500">Click to upload or drag and drop your CSV file</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column - Recent Impact -->
        <div class="col-span-1">
          <div class="bg-white border border-gray-200 rounded-lg p-4 sticky top-8">
            <h3 class="text-base font-semibold text-gray-700 mb-4">Recent Impact</h3>
            
            <div class="mb-4">
              <div class="text-2xl font-bold text-gray-900"><%= number_with_delimiter(@suppression_stats[:total_suppressed]) %></div>
              <div class="text-xs text-gray-600"><%= @suppression_stats[:percentage_suppressed] %>% of total addressables</div>
            </div>
            
            <div class="space-y-0 border-t border-gray-200">
              <% if @advertiser.recent_order_suppression_days > 0 %>
                <div class="flex items-center justify-between py-1.5 border-b border-gray-200">
                  <span class="text-xs text-gray-700">Recent orders (<%= @advertiser.recent_order_suppression_days %> days)</span>
                  <span class="text-xs font-semibold text-gray-700"><%= number_with_delimiter(@suppression_stats[:recent_orders_count]) %></span>
                </div>
              <% end %>
              
              <% if @advertiser.recent_mail_suppression_days > 0 %>
                <div class="flex items-center justify-between py-1.5 border-b border-gray-200">
                  <span class="text-xs text-gray-700">Recently mailed (<%= @advertiser.recent_mail_suppression_days %> days)</span>
                  <span class="text-xs font-semibold text-gray-700"><%= number_with_delimiter(@suppression_stats[:recent_mail_count]) %></span>
                </div>
              <% end %>
              
              <% if @advertiser.dnm_enabled && @suppression_stats[:suppression_list_count] > 0 %>
                <div class="flex items-center justify-between py-1.5 border-b border-gray-200">
                  <span class="text-xs text-gray-700">Suppression List</span>
                  <span class="text-xs font-semibold text-gray-700"><%= number_with_delimiter(@suppression_stats[:suppression_list_count]) %></span>
                </div>
              <% end %>
              
              <% if @suppression_stats[:total_suppressed] == 0 %>
                <div class="py-4 text-center">
                  <p class="text-xs text-gray-500">No contacts currently suppressed</p>
                </div>
              <% end %>
            </div>
            
            <div class="mt-4 bg-gray-100 border border-gray-200 rounded p-2">
              <p class="text-xs text-gray-500 text-center">Impact based on current suppression rules applied to <%= number_with_delimiter(@suppression_stats[:total_contacts]) %> total contacts.</p>
            </div>
          </div>
        </div>
    </div>
  </div>
<% end %>

<!-- Hidden file input for CSV upload -->
<%= form_with url: settings_import_dnm_path(@advertiser.slug), method: :post, multipart: true, class: "hidden" do |f| %>
  <%= f.file_field :csv_file, accept: ".csv", id: "csv-upload-input", onchange: "this.form.submit()" %>
<% end %>

<style>
.slider-dark::-webkit-slider-thumb {
  appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: white;
  border: 1px solid #171717;
  cursor: pointer;
}

.slider-dark::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: white;
  border: 1px solid #171717;
  cursor: pointer;
}

.slider-dark::-webkit-slider-runnable-track {
  background: linear-gradient(to right, #171717 0%, #171717 var(--value), #e5e7eb var(--value), #e5e7eb 100%);
  height: 8px;
  border-radius: 999px;
}

.slider-dark::-moz-range-track {
  background: #e5e7eb;
  height: 8px;
  border-radius: 999px;
}

.slider-dark::-moz-range-progress {
  background: #171717;
  height: 8px;
  border-radius: 999px;
}
</style>

<script>
let impactUpdateTimeout = null;

function updateOrderValue(value) {
  document.getElementById('recent-order-value').textContent = value + ' days';
  updateOrderDescription(value);
  updateSliderProgress(event.target, value, 7, 90);
  debouncedUpdateImpact();
}

function updateMailValue(value) {
  document.getElementById('recent-mail-value').textContent = value + ' days';
  updateMailDescription(value);
  updateSliderProgress(event.target, value, 7, 90);
  debouncedUpdateImpact();
}

function updateOrderDescription(days) {
  const desc = document.getElementById('recent-order-description');
  if (days >= 60) {
    desc.textContent = 'Very conservative - Best for infrequent purchase categories';
  } else if (days >= 30) {
    desc.textContent = 'Balanced - Best for products that are purchased every 1-2 months';
  } else {
    desc.textContent = 'Aggressive - Best for frequently purchased products';
  }
}

function updateMailDescription(days) {
  const desc = document.getElementById('recent-mail-description');
  if (days >= 60) {
    desc.textContent = 'Very conservative - Best for infrequent campaigns';
  } else if (days >= 30) {
    desc.textContent = 'Balanced - Best for products that are purchased every 1-2 months';
  } else {
    desc.textContent = 'Aggressive - Best for high-frequency campaigns';
  }
}

function updateSliderProgress(slider, value, min, max) {
  const percentage = ((value - min) / (max - min)) * 100;
  slider.style.setProperty('--value', percentage + '%');
}

function toggleRecentOrders(enabled) {
  const slider = document.querySelector('input[name="advertiser[recent_order_suppression_days]"]');
  if (!enabled) {
    slider.value = 0;
    updateOrderValue(0);
  } else if (slider.value == 0) {
    slider.value = 30;
    updateOrderValue(30);
  }
  debouncedUpdateImpact();
}

function toggleRecentMail(enabled) {
  const slider = document.querySelector('input[name="advertiser[recent_mail_suppression_days]"]');
  if (!enabled) {
    slider.value = 0;
    updateMailValue(0);
  } else if (slider.value == 0) {
    slider.value = 14;
    updateMailValue(14);
  }
  debouncedUpdateImpact();
}

// Debounced function to update impact stats
function debouncedUpdateImpact() {
  clearTimeout(impactUpdateTimeout);
  impactUpdateTimeout = setTimeout(updateImpactStats, 300);
}

// Fetch and update impact statistics from server
function updateImpactStats() {
  const orderDays = parseInt(document.querySelector('input[name="advertiser[recent_order_suppression_days]"]').value);
  const mailDays = parseInt(document.querySelector('input[name="advertiser[recent_mail_suppression_days]"]').value);
  
  const url = '<%= settings_preview_suppression_impact_path(@advertiser.slug) %>';
  const params = new URLSearchParams({
    recent_order_days: orderDays,
    recent_mail_days: mailDays
  });
  
  fetch(`${url}?${params}`)
    .then(response => response.json())
    .then(data => {
      // Update total suppressed
      const totalElement = document.querySelector('.text-2xl.font-bold.text-gray-900');
      if (totalElement) {
        totalElement.textContent = data.total_suppressed.toLocaleString();
      }
      
      // Update percentage
      const percentageElement = document.querySelector('.text-xs.text-gray-600');
      if (percentageElement) {
        percentageElement.textContent = `${data.percentage_suppressed}% of total addressables`;
      }
      
      // Update breakdown items
      updateBreakdownItem('Recent orders', orderDays, data.recent_orders_count);
      updateBreakdownItem('Recently mailed', mailDays, data.recent_mail_count);
    })
    .catch(error => {
      console.error('Error updating impact stats:', error);
    });
}

function updateBreakdownItem(label, days, count) {
  const items = document.querySelectorAll('.space-y-0 .flex.items-center.justify-between');
  
  items.forEach(item => {
    const labelElement = item.querySelector('.text-xs.text-gray-700');
    if (labelElement && labelElement.textContent.includes(label)) {
      const countElement = item.querySelector('.text-xs.font-semibold.text-gray-700');
      if (countElement) {
        countElement.textContent = count.toLocaleString();
      }
      // Update the days in the label
      labelElement.textContent = `${label} (${days} days)`;
    }
  });
}

// Initialize slider progress on page load
document.addEventListener('DOMContentLoaded', function() {
  const orderSlider = document.querySelector('input[name="advertiser[recent_order_suppression_days]"]');
  const mailSlider = document.querySelector('input[name="advertiser[recent_mail_suppression_days]"]');
  
  if (orderSlider) {
    updateSliderProgress(orderSlider, orderSlider.value, 7, 90);
  }
  
  if (mailSlider) {
    updateSliderProgress(mailSlider, mailSlider.value, 7, 90);
  }
});
</script>

