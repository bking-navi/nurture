<!-- Flash Messages -->
<% if notice %>
  <div class="mb-6 bg-green-50 border border-green-200 rounded-md p-4">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="ml-3">
        <p class="text-sm font-medium text-green-800"><%= notice %></p>
      </div>
    </div>
  </div>
<% end %>

<% if alert %>
  <div class="mb-6 bg-red-50 border border-red-200 rounded-md p-4">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="ml-3">
        <p class="text-sm font-medium text-red-800"><%= alert %></p>
      </div>
    </div>
  </div>
<% end %>

<!-- CSV Upload Controller Wrapper -->
<div data-controller="csv-upload">
  <!-- Header -->
  <div class="mb-6 sm:flex sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Audience</h1>
      <p class="mt-1 text-sm text-gray-500">View and manage all your contacts from Shopify, CSV imports, and manual entries</p>
    </div>
    <div class="mt-4 sm:mt-0 flex gap-3">
      <%= link_to new_contact_path(@advertiser.slug), class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700" do %>
        <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" />
        </svg>
        Add Contact
      <% end %>
      <button type="button" data-action="click->csv-upload#open" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-950 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700">
        <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
        </svg>
        Upload CSV
      </button>
    </div>
  </div>

  <!-- CSV Upload Modal -->
  <div class="hidden fixed inset-0 bg-black bg-opacity-50 z-50" data-csv-upload-target="modal" data-action="click->csv-upload#close">
  <div class="flex items-center justify-center min-h-screen px-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6" data-action="click->csv-upload#stopPropagation">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Upload CSV</h3>
        <button type="button" data-action="click->csv-upload#close" class="text-gray-400 hover:text-gray-500">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <%= form_with url: import_contacts_csv_path(@advertiser.slug), method: :post, multipart: true do |f| %>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Select CSV File
            </label>
            <%= f.file_field :csv_file, accept: ".csv", required: true, class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-gray-950 file:text-white hover:file:bg-gray-900" %>
          </div>
          
          <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm text-blue-700">
                  Your CSV should include columns: first_name, last_name, email (or phone), and optionally: address_line1, address_line2, city, state, zip
                </p>
                <p class="mt-2">
                  <%= link_to "Download sample CSV", download_contacts_sample_path(@advertiser.slug), class: "text-sm font-medium text-blue-700 hover:text-blue-600" %>
                </p>
              </div>
            </div>
          </div>
          
          <div class="flex justify-end gap-3 pt-2">
            <button type="button" data-action="click->csv-upload#close" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700">
              Cancel
            </button>
            <%= f.submit "Upload", class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-950 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
  </div>
</div>

<!-- Search and Filter Bar -->
<div class="bg-white shadow sm:rounded-lg mb-6 p-4">
  <%= form_with url: audience_path(@advertiser.slug), method: :get, class: "sm:flex sm:items-center sm:space-x-4" do |f| %>
    <div class="flex-1">
      <%= f.text_field :search, 
          value: params[:search], 
          placeholder: "Search by name or email...", 
          class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-gray-700 focus:ring-gray-700 sm:text-sm" %>
    </div>
    
    <div class="mt-3 sm:mt-0">
      <%= f.select :source, 
          [["All Sources", ""], ["Shopify", "shopify"], ["Manual", "manual"]], 
          { selected: params[:source] },
          class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-gray-700 focus:ring-gray-700 sm:text-sm" %>
    </div>
    
    <div class="mt-3 sm:mt-0 flex items-center">
      <label class="flex items-center text-sm text-gray-700">
        <%= check_box_tag :suppressed, 'true', params[:suppressed] == 'true', class: "rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2" %>
        On DNM List
      </label>
    </div>
    
    <div class="mt-3 sm:mt-0 flex space-x-2">
      <%= f.submit "Search", class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-950 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700" %>
      <% if params[:search].present? || params[:source].present? || params[:suppressed].present? %>
        <%= link_to "Clear", audience_path(@advertiser.slug), class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700" %>
      <% end %>
    </div>
  <% end %>
</div>

<!-- Stats Bar -->
<div class="bg-white shadow sm:rounded-lg mb-6">
  <div class="px-6 py-4">
    <div class="flex items-center justify-between">
      <div class="text-sm text-gray-500">
        <span class="font-medium text-gray-900"><%= @contacts.total_count %></span> 
        <%= "contact".pluralize(@contacts.total_count) %>
        <% if params[:search].present? || params[:source].present? || params[:suppressed].present? %>
          <span class="ml-2 text-gray-400">(filtered)</span>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Contacts Table -->
<div class="bg-white shadow sm:rounded-lg overflow-hidden">
  <% if @contacts.any? %>
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Name
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Email
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Phone
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Source
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Added
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @contacts.each do |contact| %>
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div>
                  <div class="text-sm font-medium text-gray-900">
                    <%= contact.display_name %>
                  </div>
                  <% if contact.from_shopify? && contact.shopify_url.present? %>
                    <%= link_to "View in Shopify →", contact.shopify_url, target: "_blank", class: "text-xs text-blue-600 hover:text-blue-800" %>
                  <% end %>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900"><%= contact.email %></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900"><%= contact.phone %></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= 
                case contact.source_type
                when 'ShopifyStore' then 'bg-purple-100 text-purple-800'
                when 'Advertiser' then 'bg-gray-100 text-gray-800'
                else 'bg-gray-100 text-gray-800'
                end
              %>">
                <%= 
                  case contact.source_type
                  when 'ShopifyStore' then 'Shopify'
                  when 'Advertiser' then 'Manual'
                  else contact.source_type
                  end
                %>
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= time_ago_in_words(contact.created_at) %> ago
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <div class="p-12 text-center">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900">No contacts found</h3>
      <p class="mt-1 text-sm text-gray-500">
        <% if params[:search].present? || params[:source].present? %>
          Try adjusting your search or filter criteria.
        <% else %>
          Get started by importing contacts from Shopify, uploading a CSV, or adding them manually in a campaign.
        <% end %>
      </p>
      <% if params[:search].present? || params[:source].present? %>
        <div class="mt-6">
          <%= link_to "Clear Filters", audience_path(@advertiser.slug), class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-950 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700" %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<!-- Pagination -->
<% if @contacts.total_pages > 1 %>
  <div class="mt-6 bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 rounded-lg shadow">
    <%= paginate @contacts %>
  </div>
<% end %>

