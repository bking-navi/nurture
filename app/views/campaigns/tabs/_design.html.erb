<div class="max-w-4xl mx-auto">
  
  <!-- Choose from Library Section -->
  <% if advertiser.creatives.active.approved.any? %>
    <div class="mb-8">
      <h3 class="text-lg font-medium text-gray-900 mb-2">Choose from Library</h3>
      <p class="text-sm text-gray-600 mb-6">Select an approved creative from your library or upload new files below</p>
      
      <%= form_with model: campaign, 
                    url: campaign_path(advertiser.slug, campaign), 
                    method: :patch,
                    local: true,
                    data: { turbo: false } do |f| %>
        <%= hidden_field_tag :tab, 'design' %>
        
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-4">
          <% advertiser.creatives.active.approved.recent.limit(10).each do |creative| %>
            <label class="relative cursor-pointer group">
              <%= f.radio_button :creative_id, 
                    creative.id,
                    checked: campaign.creative_id == creative.id,
                    class: "peer sr-only",
                    onchange: "this.form.submit()" %>
              
              <div class="border-2 rounded-lg overflow-hidden transition-all peer-checked:border-gray-900 peer-checked:ring-2 peer-checked:ring-gray-900 hover:border-gray-400">
                <div class="aspect-[2/3] bg-gray-100 flex items-center justify-center">
                  <% if creative.thumbnail.attached? %>
                    <%= image_tag creative.thumbnail, class: "w-full h-full object-cover" %>
                  <% else %>
                    <svg class="h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                  <% end %>
                </div>
                
                <div class="p-2 bg-white border-t">
                  <div class="text-xs font-medium text-gray-900 truncate"><%= creative.name %></div>
                </div>
                
                <!-- Selected indicator -->
                <div class="hidden peer-checked:flex absolute top-2 right-2 items-center justify-center w-6 h-6 bg-gray-950 rounded-full">
                  <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                </div>
              </div>
            </label>
          <% end %>
        </div>
        
        <% if advertiser.creatives.active.approved.count > 10 %>
          <div class="text-center">
            <%= link_to "View All Approved Creatives (#{advertiser.creatives.active.approved.count})", 
                        creatives_path(advertiser.slug), 
                        class: "text-sm text-gray-600 hover:text-gray-900", 
                        target: "_blank" %>
          </div>
        <% end %>
        
        <% if advertiser.creatives.active.pending_approval.any? || advertiser.creatives.active.rejected.any? || advertiser.creatives.active.failed_validation.any? %>
          <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
            <p>
              <strong>Note:</strong> Only approved creatives are shown here. 
              <% unapproved_count = advertiser.creatives.active.where.not(approval_status: 'approved').count %>
              <% if unapproved_count > 0 %>
                You have <%= unapproved_count %> <%= 'creative'.pluralize(unapproved_count) %> pending approval.
              <% end %>
            </p>
          </div>
        <% end %>
        
        <% if campaign.creative_id.present? %>
          <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span class="text-sm font-medium text-green-900">
                  Using: <%= campaign.creative.name %>
                </span>
              </div>
              <%= button_tag type: "submit", name: "creative_id", value: "", class: "text-sm text-green-700 hover:text-green-900" do %>
                Clear selection
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
    
    <div class="relative mb-8">
      <div class="absolute inset-0 flex items-center" aria-hidden="true">
        <div class="w-full border-t border-gray-300"></div>
      </div>
      <div class="relative flex justify-center">
        <span class="px-3 bg-gray-50 text-sm text-gray-500">or upload new files</span>
      </div>
    </div>
  <% end %>
  
  <!-- PDF Upload Section -->
  <div class="mb-8">
    <h3 class="text-lg font-medium text-gray-900 mb-2"><%= advertiser.creatives.active.any? ? 'Upload New Design' : 'Upload Your Design' %></h3>
    <p class="text-sm text-gray-600 mb-4">Upload PDF files for the front and back of your postcard</p>
    
    <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
      <p><strong>Note:</strong> Uploaded PDFs will require proof approval on the Review tab before you can send the campaign.</p>
    </div>
    
    <%= form_with model: campaign, 
                  url: campaign_path(advertiser.slug, campaign), 
                  method: :patch,
                  local: true,
                  multipart: true,
                  data: { turbo: false } do |f| %>
      <%= hidden_field_tag :tab, 'design' %>
      
      <div class="bg-white rounded-lg border border-gray-200 p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Front PDF Upload -->
          <div data-controller="pdf-preview">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Front Side (PDF)
              <span class="text-red-600">*</span>
            </label>
            
            <%= f.file_field :front_pdf, 
                accept: "application/pdf", 
                class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-gray-700 file:text-white hover:file:bg-gray-600",
                data: { 
                  pdf_preview_target: "input",
                  action: "change->pdf-preview#preview"
                } %>
            <p class="mt-1 text-xs text-gray-500">PDF up to 10MB, 6x9 inches</p>
            
            <!-- Preview Container -->
            <div data-pdf-preview-target="previewContainer" class="hidden mt-4">
              <div class="border border-gray-300 rounded-lg overflow-hidden bg-gray-50">
                <embed data-pdf-preview-target="preview" type="application/pdf" class="w-full h-64" />
              </div>
              <div class="mt-2 text-xs text-gray-600">
                <span data-pdf-preview-target="fileName"></span> 
                (<span data-pdf-preview-target="fileSize"></span>)
              </div>
            </div>
            
            <% if campaign.front_pdf.attached? %>
              <div class="mt-2 flex items-center gap-2 text-sm text-green-600">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span>âœ“ Previously uploaded: <%= campaign.front_pdf.filename %></span>
              </div>
            <% end %>
          </div>
          
          <!-- Back PDF Upload -->
          <div data-controller="pdf-preview">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Back Side (PDF)
              <span class="text-red-600">*</span>
            </label>
            
            <%= f.file_field :back_pdf, 
                accept: "application/pdf", 
                class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-gray-700 file:text-white hover:file:bg-gray-600",
                data: { 
                  pdf_preview_target: "input",
                  action: "change->pdf-preview#preview"
                } %>
            <p class="mt-1 text-xs text-gray-500">PDF up to 10MB, 6x9 inches</p>
            
            <!-- Preview Container -->
            <div data-pdf-preview-target="previewContainer" class="hidden mt-4">
              <div class="border border-gray-300 rounded-lg overflow-hidden bg-gray-50">
                <embed data-pdf-preview-target="preview" type="application/pdf" class="w-full h-64" />
              </div>
              <div class="mt-2 text-xs text-gray-600">
                <span data-pdf-preview-target="fileName"></span> 
                (<span data-pdf-preview-target="fileSize"></span>)
              </div>
            </div>
            
            <% if campaign.back_pdf.attached? %>
              <div class="mt-2 flex items-center gap-2 text-sm text-green-600">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span>âœ“ Previously uploaded: <%= campaign.back_pdf.filename %></span>
              </div>
            <% end %>
          </div>
        </div>
        
        <div class="mt-6 flex items-center justify-between pt-4 border-t border-gray-200">
          <div class="text-sm text-gray-500">
            <span class="font-medium">Requirements:</span> PDF format, 6x9 inches, 300 DPI
          </div>
          <%= f.submit "Upload Files", class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-950 hover:bg-gray-900" %>
        </div>
      </div>
    <% end %>
    
    <script>
      function showFileName(input, displayId) {
        const displayDiv = document.getElementById(displayId);
        const textSpan = document.getElementById(displayId.replace('-name', '-text'));
        
        if (input.files && input.files[0]) {
          const fileName = input.files[0].name;
          const fileSize = (input.files[0].size / 1024 / 1024).toFixed(2); // MB
          
          textSpan.textContent = `Selected: ${fileName} (${fileSize} MB)`;
          displayDiv.classList.remove('hidden');
        } else {
          displayDiv.classList.add('hidden');
        }
      }
    </script>
  </div>
  
  <!-- Or Use Template Button -->
  <div class="mb-8 text-center">
    <button type="button" 
            onclick="document.getElementById('template-section').classList.toggle('hidden')"
            class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
      </svg>
      Or use a custom template
    </button>
  </div>
  
  <!-- Template Selection (Hidden by default) -->
  <div id="template-section" class="hidden">
    <%= form_with model: campaign, 
                  url: campaign_path(advertiser.slug, campaign), 
                  method: :patch, 
                  local: true,
                  data: { controller: "auto-submit" } do |f| %>
      <%= hidden_field_tag :tab, 'design' %>
      
      <div class="mb-8">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Choose a Template</h3>
        <p class="text-sm text-gray-600 mb-6">Select a professionally designed postcard template</p>
        
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          <% @templates.each do |template| %>
            <label class="relative cursor-pointer group">
              <%= f.radio_button :postcard_template_id, 
                    template.id,
                    checked: campaign.postcard_template_id == template.id,
                    class: "peer sr-only",
                    data: { action: "change->auto-submit#submit" } %>
              
              <div class="border-2 rounded-lg overflow-hidden transition-all peer-checked:border-gray-700 peer-checked:ring-2 peer-checked:ring-gray-700 hover:border-gray-400">
                <!-- Template preview card -->
                <div class="aspect-[6/9] <%= 
                  case template.category
                  when 'offer' then 'bg-gradient-to-br from-red-100 to-orange-100'
                  when 'product' then 'bg-gradient-to-br from-blue-100 to-cyan-100'
                  when 'event' then 'bg-gradient-to-br from-purple-100 to-pink-100'
                  when 'welcome' then 'bg-gradient-to-br from-green-100 to-teal-100'
                  when 'seasonal' then 'bg-gradient-to-br from-amber-100 to-yellow-100'
                  else 'bg-gradient-to-br from-gray-100 to-gray-200'
                  end
                %> flex items-center justify-center text-4xl">
                  <%= 
                    case template.category
                    when 'offer' then 'ðŸ”¥'
                    when 'product' then 'ðŸ“¦'
                    when 'event' then 'ðŸŽ‰'
                    when 'welcome' then 'ðŸ’Œ'
                    when 'seasonal' then 'ðŸŽ„'
                    else 'ðŸ“®'
                    end
                  %>
                </div>
                
                <div class="p-3 bg-white border-t">
                  <div class="text-sm font-medium text-gray-900"><%= template.name %></div>
                  <div class="text-xs text-gray-500 mt-0.5"><%= template.category_label %></div>
                </div>
                
                <!-- Selected indicator -->
                <div class="hidden peer-checked:flex absolute top-2 right-2 items-center justify-center w-6 h-6 bg-gray-950 rounded-full">
                  <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                </div>
              </div>
            </label>
          <% end %>
        </div>
      </div>
    <% end %>
    
    <!-- Design Content for Templates -->
    <% if campaign.postcard_template.present? %>
      <div data-controller="preview-updater"
           data-preview-updater-advertiser-slug-value="<%= advertiser.slug %>"
           data-preview-updater-campaign-id-value="<%= campaign.id %>">
        <%= form_with model: campaign, 
                      url: campaign_path(advertiser.slug, campaign), 
                      method: :patch,
                      local: true do |f| %>
          <%= hidden_field_tag :tab, 'design' %>
          <%= render "campaigns/tabs/design_form", campaign: campaign, advertiser: advertiser, f: f %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
